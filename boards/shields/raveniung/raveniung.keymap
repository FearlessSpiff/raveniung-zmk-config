/*
 * Copyright (c) 2020 The ZMK Contributors
 *
 * SPDX-License-Identifier: MIT
 */

#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/pointing.h>
#include <dt-bindings/zmk/outputs.h>
#include <dt-bindings/zmk/ext_power.h>
#include <dt-bindings/zmk/input_transform.h>
#include <input/processors.dtsi>
#include "keymap_german.h"

// Layers
// Win and Linux
#define DEF     0
#define NAV     1
#define SYM     2
#define NUM     3
#define FN      4
#define SET     5

// Global
#define MSE     6
#define SCRL    7

// Special shortcuts
#define ________     &trans
#define TODO         &trans
#define DEL_W        &kp LC(BSPC)
#define SPACE_SYM    &lt SYM SPACE
#define Q_MSE        &lt MSE Q
#define A_NAV        &lt NAV A
#define EXT_ON       &ext_power EP_ON
#define SCRL_D       &msc SCRL_DOWN
#define SCRL_U       &msc SCRL_UP

#define BT_1       &bt BT_SEL 0
#define BT_2       &bt BT_SEL 1
#define BT_3       &bt BT_SEL 2
#define BT_4       &bt BT_SEL 3
#define BT_5       &bt BT_SEL 4
#define BT_6       &bt BT_SEL 5
#define BT_CLEAR   &bt BT_CLR

// home row mod left
#define ALT_S &hm LALT S
#define CTL_D &hm LCTRL D
#define SFT_F &hm LSHIFT F
#define GUI_Y &hm LGUI Y

// home row mod right
#define SFT_J     &hm RSHIFT J
#define CTL_K     &hm RCTRL K
#define RALT_L    &hm RALT L
#define LALT_OE   &hm LALT DE_ODIA
#define LGUI_UE   &hm LGUI DE_UDIA

&sk {
        release-after-ms = <3000>;
};

/ {
    glidepoint_listener {
        compatible = "zmk,input-listener";
        device = <&glidepoint>;
        input-processors 
//          = <&zip_temp_layer MSE 1200>
          = <&zip_xy_scaler 2 1>;

        scroll {
            layers = <SCRL>;
            input-processors
              = <&zip_xy_scaler 1 32>
              , <&zip_xy_transform INPUT_TRANSFORM_Y_INVERT> /* natural scroll */
              , <&zip_xy_to_scroll_mapper>
            ;
        };
    };

    macros {

        ZMK_MACRO(lck,
            wait-ms = <30>;
            tap-ms = <40>;
            bindings
                = <&macro_press   &kp LGUI>
                , <&macro_tap     &kp L>
                , <&macro_release &kp LGUI>
                ;
        )

    };


    combos {
        compatible = "zmk,combos";

        combo_tab {
            timeout-ms = <50>;
            key-positions = <9 21>;
            bindings = <&kp TAB>;
        };

        combo_enter {
            timeout-ms = <50>;
            key-positions = <18 30>;
            bindings = <&kp RET>;
        };
        
        combo_esc {
            timeout-ms = <50>;
            key-positions = <8 20>;
            bindings = <&kp ESC>;
        };

    };

    behaviors {
        hm: homerow_mods {
                    compatible = "zmk,behavior-hold-tap";
                    #binding-cells = <2>;
                    tapping-term-ms = <180>;
                    quick-tap-ms = <0>;
                    flavor = "tap-preferred";
                    bindings = <&kp>, <&kp>;
            };
    };


    keymap {
        compatible = "zmk,keymap";

        default_layer {
            bindings = <
                                 &kp W  &kp E  &kp R    &kp T             &kp DE_Z   &kp U      &kp I      &kp O
               Q_MSE      A_NAV  ALT_S  CTL_D  SFT_F    &kp G             &kp H      SFT_J      CTL_K      RALT_L   LALT_OE  &kp DE_P
               &kp DE_SS  GUI_Y  &kp X  &kp C  &kp V    &kp B             &kp N      &kp M      &kp COMMA  &kp DOT  LGUI_UE  &kp DE_ADIA
                                               &mo NUM  &kp LSHFT         SPACE_SYM  &kp BSPC
             >;
        };

        nav_layer {
            bindings = <
            	                    &lck      ________  ________  ________             &kp PG_UP  &kp HOME  &kp UP    &kp END
            	&kp ESC  ________   ________  ________  ________  ________             &kp PG_DN  &kp LEFT  &kp DOWN  &kp RIGHT  ________  ________
            	TODO     &kp LSHFT  ________  ________  ________  ________             ________   ________  ________  ________   ________  ________
            	                                        ________  ________             ________   &kp DEL
            >;
        };

        sym_layer {
        // ---------------------------------------------------------------------
        // |  ^  |  _  |  {  |  }  |  ยง  |       |  !  |  <  |  >  |  =  |  &  |
        // |  \  |  /  |  (  |  )  |  *  |       |  ?  |  [  |  ]  |  -  |  :  |
        // |  `  |  $  |  |  |  ~  |  #  |       |  +  |  %  |  "  |  '  |  ;  |
        //                   | --- | --- |       | --- | --- |
          	bindings = <
                                         &kp DE_UNDS  &kp DE_LCBR  &kp DE_RCBR  &kp DE_SECT          &kp DE_EXLM  &kp DE_LABK  &kp DE_RABK  &kp DE_EQL
               &kp DE_CIRC  &kp DE_BSLS  &kp DE_SLSH  &kp DE_LPRN  &kp DE_RPRN  &kp DE_ASTR          &kp DE_QUES  &kp DE_LBRC  &kp DE_RBRC  &kp DE_MINS  &kp DE_COLN  &kp DE_AMPR
               TODO         &kp DE_ACUT  &kp DE_DLR   &kp DE_PIPE  &kp DE_TILD  &kp DE_HASH          &kp DE_PLUS  &kp DE_PERC  &kp DE_DQUO  &kp DE_QUOT  &kp DE_SCLN  TODO
        	                                                         &kp DE_AT    ________             ________     ________
          	>;
        };

        num_layer {
            bindings = <
                                    ________  ________  &mo SET     ________         &kp DE_SLSH  &kp N7   &kp N8    &kp N9
                ________  &sk LGUI  &sk RALT  &sk LCTRL &sk LSHIFT  ________         &kp DE_ASTR  &kp N4   &kp N5    &kp N6  &kp DE_PLUS  &kp DE_MINS
                TODO      &sk LALT  ________  ________  &mo FN      ________         &kp COMMA    &kp N1   &kp N2    &kp N3  &kp N0       TODO
                                                        ________    ________         &kp DE_COLN  &kp DOT
            >;
        };

        fn_layer {
            bindings = <
                                    ________  ________  ________  ________          ________  &kp F7  &kp F8  &kp F9
                ________  ________  ________  ________  ________  ________          ________  &kp F4  &kp F5  &kp F6  ________  ________
                TODO      ________  ________  ________  ________  ________          ________  &kp F1  &kp F2  &kp F3  &kp F10   TODO
                                                        ________  ________          &kp F11   &kp F12
            >;
        };

        settings_layer {
            bindings = <
                                    ________      ________  ________  BT_CLEAR          ________  ________  ________  ________
                TODO  &out OUT_USB  &out OUT_BLE  ________  ________  ________          ________  BT_4      BT_5      BT_6      ________   ________
                TODO  ________      ________      ________  ________  EXT_ON            ________  BT_1      BT_2      BT_3      ________   TODO
                                                            ________  ________          ________  ________
            >;
        };

        mouse_layer {
            bindings = <
                                   &mkp MB4   &mo SCRL   &mkp MB5   ________          ________  ________  ________  ________
                ________ ________  &mkp RCLK  &mkp MCLK  &mkp LCLK  ________          ________  ________  ________  ________  ________  ________
                ________ ________  ________   ________   ________   ________          ________  ________  ________  ________  ________  ________
                                                         &kp LCTRL  &kp LSHFT         ________  ________
            >;
        };

        scroll_and_media_layer {
            bindings = <
                                   ________  ________  ________  ________          ________  &kp C_PREV      &kp C_PP      &kp C_NEXT
                ________ ________  ________  ________  ________  ________          ________  &kp C_MUTE      &kp C_VOL_DN  &kp C_VOL_UP  ________  ________
                ________ ________  ________  ________  ________  ________          ________  &kp C_BRI_AUTO  &kp C_BRI_DN  &kp C_BRI_UP  ________  ________
                                                       ________  ________          ________  ________
            >;
        };

     };
};
